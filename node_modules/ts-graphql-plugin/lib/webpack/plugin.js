"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const path_1 = __importDefault(require("path"));
const transform_server_1 = require("../transformer/transform-server");
const PLUGIN_NAME = 'ts-graphql-plugin';
class WebpackPlugin {
    constructor({ tsconfigPath = process.cwd() } = {}) {
        this._disabled = false;
        this._transformServer = new transform_server_1.TransformServer({ projectPath: tsconfigPath });
    }
    getTransformer(options) {
        return this._transformServer.getTransformer(Object.assign(Object.assign({}, options), { getEnabled: () => !this._disabled }));
    }
    apply(compiler) {
        compiler.hooks.afterPlugins.tap(PLUGIN_NAME, () => this._transformServer.loadProject());
        compiler.hooks.watchRun.tap(PLUGIN_NAME, () => {
            this._disabled = compiler.options.mode === 'development';
            const watcher = compiler.watchFileSystem.watcher || compiler.watchFileSystem.wfs.watcher;
            const changedFiles = Object.keys(watcher.mtimes);
            const changedSourceFileNames = changedFiles.filter(f => path_1.default.extname(f) === '.ts' || path_1.default.extname(f) === '.tsx');
            this._transformServer.updateFiles(changedSourceFileNames);
        });
    }
}
exports.WebpackPlugin = WebpackPlugin;
//# sourceMappingURL=plugin.js.map