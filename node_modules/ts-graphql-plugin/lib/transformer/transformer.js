"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const typescript_1 = __importDefault(require("typescript"));
const graphql_1 = require("graphql");
function toObjectNode(field) {
    if (field === null) {
        return typescript_1.default.createNull();
    }
    else if (typeof field === 'boolean') {
        return field ? typescript_1.default.createTrue() : typescript_1.default.createFalse();
    }
    else if (typeof field === 'number') {
        return typescript_1.default.createNumericLiteral(field + '');
    }
    else if (typeof field === 'string') {
        return typescript_1.default.createStringLiteral(field);
    }
    else if (Array.isArray(field)) {
        return typescript_1.default.createArrayLiteral(field.map(item => toObjectNode(item)));
    }
    return typescript_1.default.createObjectLiteral(Object.entries(field)
        .filter(([k, v]) => k !== 'loc' && v !== undefined)
        .map(([k, v]) => typescript_1.default.createPropertyAssignment(typescript_1.default.createIdentifier(k), toObjectNode(v))), true);
}
function getTransformer({ tag, target, getDocumentNode, removeFragmentDefinitons, documentTransformers, getEnabled, }) {
    return (ctx) => {
        const visit = (node) => {
            var _a;
            if (!getEnabled())
                return node;
            let templateNode = undefined;
            if (typescript_1.default.isImportDeclaration(node)) {
                const ret = typescript_1.default.visitEachChild(node, visit, ctx);
                let hasIdentifier = false;
                const find = (n) => {
                    hasIdentifier = hasIdentifier || typescript_1.default.isIdentifier(n);
                    typescript_1.default.forEachChild(n, find);
                };
                typescript_1.default.forEachChild(ret, find);
                if (!hasIdentifier)
                    return undefined;
                return ret;
            }
            if (typescript_1.default.isImportSpecifier(node)) {
                const removed = !!tag && node.name.text === tag;
                return removed ? undefined : node;
            }
            if (typescript_1.default.isImportClause(node) && !!node.name) {
                const removed = !!tag && ((_a = node.name) === null || _a === void 0 ? void 0 : _a.text) === tag;
                const ret = typescript_1.default.visitEachChild(node, visit, ctx);
                if (!removed)
                    return ret;
                return typescript_1.default.updateImportClause(ret, undefined, ret.namedBindings);
            }
            if (typescript_1.default.isTaggedTemplateExpression(node) && (!tag || (typescript_1.default.isIdentifier(node.tag) && node.tag.text === tag))) {
                templateNode = node.template;
            }
            else if (!tag && typescript_1.default.isNoSubstitutionTemplateLiteral(node)) {
                templateNode = node;
            }
            else if (!tag && typescript_1.default.isTemplateExpression(node)) {
                templateNode = node;
            }
            else {
                return typescript_1.default.visitEachChild(node, visit, ctx);
            }
            if (!templateNode)
                return typescript_1.default.visitEachChild(node, visit, ctx);
            const originalDocumentNode = getDocumentNode(templateNode);
            if (!originalDocumentNode)
                return typescript_1.default.visitEachChild(node, visit, ctx);
            const documentNode = documentTransformers.reduce((doc, dt) => dt(doc), originalDocumentNode);
            if (!documentNode)
                return typescript_1.default.visitEachChild(node, visit, ctx);
            const toBeRemoved = removeFragmentDefinitons && documentNode.definitions.every(def => def.kind === 'FragmentDefinition');
            if (target === 'text') {
                if (toBeRemoved)
                    return typescript_1.default.createStringLiteral('');
                return typescript_1.default.createStringLiteral(graphql_1.print(documentNode));
            }
            if (toBeRemoved)
                return typescript_1.default.createNumericLiteral('0');
            return toObjectNode(documentNode);
        };
        return (sourceFile) => typescript_1.default.visitEachChild(sourceFile, visit, ctx);
    };
}
exports.getTransformer = getTransformer;
//# sourceMappingURL=transformer.js.map